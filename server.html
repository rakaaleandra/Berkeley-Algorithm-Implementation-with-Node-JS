<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Berkeley Time Sync Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-gray-100 font-sans">

    <div class="max-w-5xl mx-auto p-6">
        <h1 class="text-3xl font-bold text-center mb-8 text-emerald-400">Server Time Dashboard</h1>

        <div class="grid md:grid-cols-2 gap-6 mb-8">
            <div class="bg-gray-800 border border-gray-700 rounded-xl p-4 text-center shadow-lg">
                <h2 class="text-lg font-semibold text-emerald-300 mb-2">Waktu Server (Sebelum)</h2>
                <div id="server-before" class="text-2xl font-mono">--:--:--</div>
            </div>
            <div class="bg-gray-800 border border-gray-700 rounded-xl p-4 text-center shadow-lg">
                <h2 class="text-lg font-semibold text-emerald-300 mb-2">Waktu Server (Setelah Berkeley)</h2>
                <div id="server-after" class="text-2xl font-mono">--:--:--</div>
            </div>
            <div class="bg-gray-800 border border-gray-700 rounded-xl p-4 text-center shadow-lg col-span-2">
                <h2 class="text-lg font-semibold text-emerald-300 mb-2">Server Offset</h2>
                <div id="server-offset" class="text-2xl font-mono">0 ms</div>
            </div>
        </div>

        <div class="bg-gray-800 border border-gray-700 rounded-xl p-4 shadow-lg mb-6">
            <h2 class="text-lg font-semibold text-emerald-300 mb-3">Daftar Client</h2>
            <div class="overflow-x-auto rounded-lg">
                <table class="min-w-full text-sm text-gray-200 border-collapse">
                    <thead class="bg-emerald-600 text-white uppercase text-xs">
                        <tr>
                            <th class="px-4 py-2 text-left">Alamat IP</th>
                            <th class="px-4 py-2 text-left">Offset (ms)</th>
                        </tr>
                    </thead>
                    <tbody id="client-table" class="divide-y divide-gray-700">
                        <tr>
                            <td colspan="3" class="px-4 py-3 text-center text-gray-400">Menunggu data sinkronisasi...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        function updateServerBefore() {
            const now = new Date();
            const h = String(now.getHours()).padStart(2, '0');
            const m = String(now.getMinutes()).padStart(2, '0');
            const s = String(now.getSeconds()).padStart(2, '0');
            document.getElementById("server-before").innerText = `${h}:${m}:${s}`;
            setTimeout(updateServerBefore, 1000);
        }
        updateServerBefore();

        const ws = new WebSocket("ws://localhost:8080");
        const output = document.getElementById("output");
        const clientTable = document.getElementById("client-table");
        const serverOffsetEl = document.getElementById("server-offset");
        const serverAfterEl = document.getElementById("server-after");

        ws.onopen = () => {
            output.textContent = "‚úÖ Terhubung ke WebSocket server.\n";
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);

            // backend hanya kirim type = "sync_result"
            if (data.type === "sync_result") {
                const { clientsIP, offsets, avgTime, timestamp } = data;
                const serverOffset = offsets[offsets.length - 1];

                // tampilkan data server
                serverOffsetEl.innerText = `${serverOffset.toFixed(2)} ms`;
                serverAfterEl.innerText = new Date(avgTime).toLocaleTimeString();

                // tampilkan data client
                if (clientsIP.length > 0) {
                    clientTable.innerHTML = "";
                    clientsIP.forEach((ip, i) => {
                        const offset = offsets[i].toFixed(2);
                        clientTable.innerHTML += `
              <tr class="hover:bg-gray-700/40 transition">
                <td class="px-4 py-2">${i + 1}</td>
                <td class="px-4 py-2">${ip}</td>
                <td class="px-4 py-2">${offset} ms</td>
              </tr>`;
                    });
                }

                // tampilkan log
                output.textContent += `üïí Sinkronisasi: ${timestamp}\nServer offset: ${serverOffset.toFixed(2)} ms\n\n`;
                output.scrollTop = output.scrollHeight;
            }
        };

        ws.onerror = (err) => {
            output.textContent += "‚ùå Gagal terhubung ke WebSocket!\n";
        };
    </script>
</body>

</html>